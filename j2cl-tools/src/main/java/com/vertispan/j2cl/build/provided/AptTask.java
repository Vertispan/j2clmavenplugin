package com.vertispan.j2cl.build.provided;

import com.google.auto.service.AutoService;
import com.vertispan.j2cl.build.DiskCache;
import com.vertispan.j2cl.build.task.*;

import java.nio.file.FileSystems;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.PathMatcher;

@AutoService(TaskFactory.class)
public class AptTask extends TaskFactory {
    public static final PathMatcher BYTECODE = FileSystems.getDefault().getPathMatcher("glob:**/*.class");
    public static final PathMatcher NOT_BYTECODE = p -> !BYTECODE.matches(p);

    @Override
    public String getOutputType() {
        return OutputTypes.GENERATED_SOURCES;
    }

    @Override
    public String getTaskName() {
        return "default";
    }

    @Override
    public Task resolve(Project project, Config config) {
        if (!project.hasSourcesMapped()) {
            // we explicitly don't copy the generated sources, they already exist in the proj sources
            return ignored -> {};
        }

        // we assume that bytecode was generated by javac, and will read the generated sources out of there
        Input myBytecode = input(project, OutputTypes.BYTECODE).filter(NOT_BYTECODE);

        return output -> {
            // the BytecodeTask already did the work for us, just copy sources to output
            for (CachedPath entry : myBytecode.getFilesAndHashes()) {
                Files.createDirectories(output.path().resolve(entry.getSourcePath()).getParent());
                Files.copy(entry.getAbsolutePath(), output.path().resolve(entry.getSourcePath()));
            }
        };
    }
}
